# Apple Wallet integration

[Apple Wallet](https://en.wikipedia.org/wiki/Wallet_(application)) (formerly Passbook) is an Apple iOS application that allows users to store passes that represent coupons, boarding passes, event tickets and store cards. Wallet is supported on iPhone and iPod Touch devices running iOS 6 or later.

The  service issues Apple Wallet passes of type `eventTicket` to users of supported devices to speed up the check-in process when users arrive for their appointment.

## Implementation

This section describes how Wallet was implemented for this service. Before proceeding it is helpful to be familiar with PassKit, please see the references below.

Code related to Wallet functionality can be found in the `wallet` package.

### Retrieve passes

Users receive an email confirming their appointment, and this email contain a link to download a pass to their Wallet. The same link is also present on the confirmation page for users who reschedule their appointment. The link is:

    /wallet/pass?id={{user_id}}&otherid={{other_id}}

If the user's device supports Wallet (detected via the `User-Agent` header), the response redirects to this URL (following the [PassKit Web Service Reference specification](https://developer.apple.com/library/ios/documentation/PassKit/Reference/PassKit_WebService/WebService.html#//apple_ref/doc/uid/TP40011988-CH0-SW6)):

    /wallet/v1/passes/{{pass_type_identifier}}/citizenship?id={{user_id}}&otherid={{other_id}}

The appointment information is returned in the pass if `user_id` and `other_id` match a user record with an appointment. The pass contains a `authorizationToken` for authenticating subsequent update requests. This means that pass updates are downloaded with the following URL and `Authorization` header combination:

    /wallet/v1/passes/{{pass_type_identifier}}/citizenship
    
    Authorization: ApplePass {{authorizationToken}} 
    
The `authorizationToken` is generated by encrypting the string `{{user_id}}:{{other_id}}`.

Note that this means all issued passes have the same value for `serialNumber`, specifically `citizenship`. This goes against the PassKit recommendation, since the combination of pass type identifier and serial number should be unique to each pass. However, in our case it is necessary due to limitations on how we can persist and retrieve user data.

If the user's device doesn't support Wallet, the response instead redirects to a page that provides instructions for how to add the pass to their Wallet should they have an iPhone or iPod Touch. The page includes a QR code that can be scanned by the Wallet application to easily add the pass.

### Register to receive pass updates

When the user installs a pass in Wallet, the Wallet application contacts the appointment service to register for automatic pass updates. The URL for registering and the authentication method is documented in the [PassKit Web Service Reference](https://developer.apple.com/library/ios/documentation/PassKit/Reference/PassKit_WebService/WebService.html#//apple_ref/doc/uid/TP40011988-CH0-SW2).
 
The pair of `deviceLibraryIdentifier` and `pushToken` from this request is persisted against the user record as it is required for sending a push notification when the pass is updated. Multiple colon-separated `deviceLibraryIdentifier` and `pushToken` pairs can be stored on a single user record, with comma separating multiple pairs in a single string.

### Push notifications

When a user reschedules their appointment, the service will send a push notification via [Apple Push Notification Service (APNs)](https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Chapters/ApplePushService.html) for each `pushToken` stored on the user record.

The push notification doesn't contain the updated pass but instead triggers the user's device to fetch the latest version of the pass from the appointment service, unless the user has decided to unregister from pass updates (see below). APNs doesn't persist or relay appointment information.

If the APNs response indicates that a `pushToken` is no longer valid it is removed from the user's profile.

### Automatically download pass updates

When a device receives a push notification to indicate that a pass should be updated, the Wallet application on the device issues requests to the appointment service:

1. Retrieve serial numbers of update passes (see below); and
2. Download updated passes (see 'Retrieve passes' section above)

### Retrieve pass serial numbers

The endpoint to retrieve pass serial numbers for a device (as documented in the [PassKit Web Service Reference](https://developer.apple.com/library/ios/documentation/PassKit/Reference/PassKit_WebService/WebService.html#//apple_ref/doc/uid/TP40011988-CH0-SW4)) always returns `citizenship` as the single `serialNumber` regardless of the device library identifier provided.

The `lastUpdated` is a random UUID as the appointment service currently can't retrieve the date and time when the reschedule took place.

### Unregister from pass updates

After a user has downloaded a pass to their device, they can choose to not receive push notifications on appointment changes by turning off the option 'Automatic Updates' on the back of the pass in the Wallet application.

Push notifications on appointment changes are also disabled if a user deletes the pass from their iOS device.
 
In these two scenarios, the Wallet application sends an unregister request using the endpoint and authentication method described in the [PassKit Web Service Reference](https://developer.apple.com/library/ios/documentation/PassKit/Reference/PassKit_WebService/WebService.html#//apple_ref/doc/uid/TP40011988-CH0-SW5).

This causes the `{{deviceLibraryIdentifier}}:{{pushToken}}` pair identified by the `deviceLibraryIdentifier` identifier from the request to be removed from the user record as determined by the encrypted `authorizationToken` in the `Authorization` header.

### Manually retrieve pass updates

Users can choose to disable automatic pass updates in the Wallet application, and this is a per-pass setting. In this scenario, users with a pass installed in Wallet who reschedule can download a new version of their pass, either from the link on the confirmation page or from the link in the confirmation email.

A pass will always contain the most up to date appointment information when it's retrieved, so it doesn't matter if a user clicks on the link from an email received before rescheduling the appointment.

### Errors

Errors from the Wallet application on a user's device are logged as per the [PassKit Web Service Reference](https://developer.apple.com/library/ios/documentation/PassKit/Reference/PassKit_WebService/WebService.html#//apple_ref/doc/uid/TP40011988-CH0-SW7) to assist in troubleshooting problems. No user details are sent in these requests.

### Additional information

#### HTTPS required

The Wallet application only permits communication over HTTPS by default. By enabling the Developer option under Settings on the iOS device it's possible to allow plain HTTP communication for development purposes.

One way to enable the Developer settings menu is to connect the iOS device to a Mac running a recent version of OS X with Xcode installed. Open the Devices window in Xcode, select the connected device, and click the button View Device Logs. The Developer option should now be available in the Settings application on the device.

#### Simulator and desktop shortcomings

We recommended to use physical devices to develop and test Wallet functionality, for the following reasons:

1. The Wallet application on the iOS simulator currently doesn't support push notifications for pass updates.

2. The Wallet application on the iOS simulator currently doesn't support relevance information to make the pass appear on the device lock screen based time or location.

3. The pass preview functionality available on recent versions of Mac OS X (10.8.2+) doesn't display the pass the way it is shown on an iOS device:

  1. On OS X long label values are truncated with an ellipsis, whereas on iOS the font size is first reduced in order to try to fit the text. After the text has shrunk to the minimum font size (which is determined by the device), the text wraps, but only to a maximum of two lines.  

  2. On OS X, if the pass doesn't have a background image, a gradient is applied to the specified background colour. On iOS the pass is displayed with a solid background colour and no gradient.

For these reasons it's recommended to use physical devices to develop and test Wallet functionality.

#### Rescheduling outside the appointment service

If an appointment is rescheduled directly in the backend system, a user with a pass on their device will not automatically receive an update since a push notification will not be triggered in this case. However, if the user downloads the pass again by following the link in the appointment email, the new pass will contain the most up to date information.

## References

[Use Wallet](https://support.apple.com/en-au/HT204003) on your iPhone or iPod touch

Apple Developer information for [integrating with Wallet](https://developer.apple.com/wallet/)

[Pass Design and Creation](https://developer.apple.com/library/ios/documentation/UserExperience/Conceptual/PassKit_PG/Creating.html)

[PassKit Package Format Reference](https://developer.apple.com/library/ios/documentation/UserExperience/Reference/PassKit_Bundle/Chapters/TopLevel.html) for the `pass.json` file in pass packages.

[Updating passes](https://developer.apple.com/library/ios/documentation/UserExperience/Conceptual/PassKit_PG/Updating.html) in Wallet using Apple Push Notification Service (APNs)

[PassKit Web Service Reference](https://developer.apple.com/library/ios/documentation/PassKit/Reference/PassKit_WebService/WebService.html)

[Apple Push Notification Service (APNs)](https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Chapters/ApplePushService.html)

Video from WWDC 2012: [Introducing Passbook, Part 1](https://developer.apple.com/videos/play/wwdc2012/301/)

Video from WWDC 2012: [Introducing Passbook, Part 2](https://developer.apple.com/videos/play/wwdc2012/309/)

Java libraries used in the implementation:

- [drallgood/jpasskit](https://github.com/drallgood/jpasskit) for generating and signing passes
- [relayrides/pushy](https://github.com/relayrides/pushy) for sending push notifications using APNs
- [netty/netty-tcnative](https://github.com/netty/netty-tcnative) and [jetty-project/jetty-alpn](https://github.com/jetty-project/jetty-alpn) for [ALPN support in Java](http://www.eclipse.org/jetty/documentation/current/alpn-chapter.html), required for integrating with APNs using HTTP/2
- [HaraldWalker/user-agent-utils](https://github.com/HaraldWalker/user-agent-utils) for detecting users's operating system and browser via the `User-Agent` header
- [zxing/zxing](https://github.com/zxing/zxing) for generating the QR code that can be scanned by the Wallet application to add the pass if the user reschedules on a device that doesn't support Wallet.
