machine:
  java:
    version: oraclejdk8
  post:
    # Install Java Cryptography Extension (JCE) Unlimited Strength Jurisdiction Policy Files for build
    - rm -f jce_policy-8.zip
    - "curl -o jce_policy-8.zip -v -j -k -L -H 'Cookie: oraclelicense=accept-securebackup-cookie' http://download.oracle.com/otn-pub/java/jce/8/jce_policy-8.zip"
    - sudo unzip -j -o -d $JAVA_HOME/jre/lib/security jce_policy-8.zip
    # Install Cloud Foundry command line client for deployment
    - "curl -v -L -o cf-cli_amd64.deb 'https://cli.run.pivotal.io/stable?release=debian64&source=github'"
    - sudo dpkg -i cf-cli_amd64.deb
    - cf -v
dependencies:
  override:
    - ./gradlew dependencies
test:
  override:
    - ./gradlew test &> /dev/null
    - ./gradlew integrationTest &> /dev/null
    - ./gradlew assemble
deployment:
  development:
    branch: master
    owner: AusDTO
    commands:
      - cf api $CF_API_DEV --skip-ssl-validation &> /dev/null
      - cf auth $CF_USER_DEV $CF_PASSWORD_DEV &> /dev/null
      - cf target -o $CF_ORG_DEV &> /dev/null
      - cf target -s $CF_SPACE_DEV &> /dev/null
      - URL=$CF_APP_URL_DEV ./bin/cideploy.sh &> /dev/null
  production:
    tag: /release-.*/
    owner: AusDTO
    commands:
      - cf api $CF_API_PROD --skip-ssl-validation &> /dev/null
      - cf auth $CF_USER_PROD $CF_PASSWORD_PROD &> /dev/null
      - cf target -o $CF_ORG_PROD &> /dev/null
      - cf target -s $CF_SPACE_PROD &> /dev/null
      - URL=$CF_APP_URL_PROD ./bin/cideploy.sh &> /dev/null
